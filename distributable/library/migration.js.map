{"version":3,"sources":["../../source/library/migration.js"],"names":["FileSystem","Luxon","Match","Path","URL","DateTime","FilePath","_URL","fileURLToPath","import","meta","url","FolderPath","dirname","Migration","constructor","path","_path","_name","basename","extname","name","isInstalled","pathExists","install","Promise","all","touch","remove","uninstall","toString","createMigration","normalize","templatePath","fromPath","toFolder","toName","utc","toFormat","toExtension","toPath","mkdir","copy","getMigration","parameter","getMigrationFromPath","includePattern","excludePattern","item","readdir","getMigrationFromPathPromise","filter","isDirectory","map","directory","importMigrationPromise","isFile","file","reduce","isMatch","pattern","importMigration","flat","sort","migration","pathToFileURL","default","installMigration","uninstallMigration","reverse"],"mappings":"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","sourcesContent":["import { FileSystem } from '@virtualpatterns/mablung-file-system'\nimport Luxon from 'luxon'\nimport Match from 'minimatch'\nimport Path from 'path'\nimport URL from 'url'\n\nconst { DateTime } = Luxon\nconst FilePath = __filePath\nconst FolderPath = Path.dirname(FilePath)\n\nclass Migration {\n\n  constructor(path) {\n    this._path = path\n    this._name = Path.basename(this._path, Path.extname(this._path))\n  }\n\n  /* c8 ignore next 3 */\n  get path() {\n    return this._path\n  }\n\n  /* c8 ignore next 3 */\n  get name() {\n    return this._name\n  }\n\n  async isInstalled() {\n    return   (await FileSystem.pathExists(`${Path.dirname(this._path)}/${this._name}.installed`)) && \n            !(await FileSystem.pathExists(`${Path.dirname(this._path)}/${this._name}.uninstalled`))\n  }\n\n  install() {\n    return Promise.all([\n      FileSystem.touch(`${Path.dirname(this._path)}/${this._name}.installed`),\n      FileSystem.remove(`${Path.dirname(this._path)}/${this._name}.uninstalled`)\n    ])\n  }\n\n  uninstall() {\n    return FileSystem.touch(`${Path.dirname(this._path)}/${this._name}.uninstalled`)\n  }\n\n  toString() {\n    return this._name\n  }\n\n  static async createMigration(name, path = Path.normalize(`${FolderPath}/../../source/library/migration`), templatePath = Path.normalize(`${FolderPath}/../../source/library/migration/template.js`)) {\n\n    let fromPath = templatePath\n\n    let toFolder = path\n    let toName = `${DateTime.utc().toFormat('yyyyLLddHHmmss')}-${name}`\n    let toExtension = Path.extname(templatePath)\n\n    let toPath = `${toFolder}/${toName}${toExtension}`\n\n    await FileSystem.mkdir(Path.dirname(toPath), { 'recursive': true })\n    await FileSystem.copy(fromPath, toPath)\n\n    return toPath\n\n  }\n\n  static getMigration(...parameter) {\n    return this.getMigrationFromPath(`${FolderPath}/migration`, [ '*.js' ], [ 'template.js' ], ...parameter)\n  }\n\n  static async getMigrationFromPath(path, includePattern, excludePattern, ...parameter) {\n\n    let item = await FileSystem.readdir(path, { 'encoding': 'utf-8', 'withFileTypes': true })\n\n    let getMigrationFromPathPromise = item\n      .filter((item) => item.isDirectory())\n      .map((directory) => this.getMigrationFromPath(`${path}/${directory.name}`, includePattern, excludePattern, ...parameter))\n\n    let importMigrationPromise = item\n      .filter((item) => item.isFile())\n      .filter((file) => includePattern.reduce((isMatch, pattern) => isMatch ? isMatch : Match(file.name, pattern), false))\n      .filter((file) => !excludePattern.reduce((isMatch, pattern) => isMatch ? isMatch : Match(file.name, pattern), false))\n      .map((file) => this.importMigration(`${path}/${file.name}`, ...parameter))\n\n    return (await Promise.all([...getMigrationFromPathPromise, ...importMigrationPromise])).flat().sort()\n\n  }\n\n  static async importMigration(path, ...parameter) {\n\n    let migration = null\n    migration = await import(URL.pathToFileURL(path))\n    migration = migration.default ? migration.default : migration\n\n    return new migration(path, ...parameter)\n    \n  }\n\n  static async installMigration(...parameter) {\n\n    for (let migration of (await this.getMigration(...parameter))) {\n\n      if (await migration.isInstalled()) {\n        // do nothing\n      } else {\n        await migration.install()\n      }\n\n    }\n\n  }\n\n  static async uninstallMigration(...parameter) {\n\n    for (let migration of (await this.getMigration(...parameter)).reverse()) {\n\n      if (await migration.isInstalled()) {\n        await migration.uninstall()\n      }\n\n    }\n\n  }\n\n}\n\nexport { Migration }\n"],"file":"migration.js"}